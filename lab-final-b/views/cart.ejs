<%- include('partials/header') %>

<section class="cart-section">
  <div class="container">
    <h1 class="cart-page-title">Shopping Cart</h1>
    
    <% if (cartItems && cartItems.length > 0) { %>
      <div class="cart-layout">
        <div class="cart-items-container">
          <% cartItems.forEach(function(item) { %>
            <div class="cart-item-card">
              <div class="cart-item-image">
                <img src="<%= item.product.image %>" alt="<%= item.product.name %>" />
              </div>
              <div class="cart-item-details">
                <h3 class="cart-item-name"><%= item.product.name %></h3>
                <p class="cart-item-rarity"><%= item.product.rarity %></p>
                <p class="cart-item-description"><%= item.product.description %></p>
                <div class="cart-item-price">$<%= item.product.price.toFixed(2) %></div>
              </div>
              <div class="cart-item-controls">
                <div class="quantity-controls">
                  <label for="quantity-<%= item.product._id %>">Quantity:</label>
                  <div class="quantity-input-group">
                    <button type="button" class="quantity-btn" onclick="updateQuantity('<%= item.product._id %>', <%= item.quantity - 1 %>)">âˆ’</button>
                    <input 
                      type="number" 
                      id="quantity-<%= item.product._id %>" 
                      value="<%= item.quantity %>" 
                      min="1" 
                      class="quantity-input"
                      onchange="updateQuantity('<%= item.product._id %>', this.value)"
                    />
                    <button type="button" class="quantity-btn" onclick="updateQuantity('<%= item.product._id %>', <%= item.quantity + 1 %>)">+</button>
                  </div>
                </div>
                <div class="cart-item-total">
                  <strong>$<%= item.itemTotal.toFixed(2) %></strong>
                </div>
                <button type="button" class="remove-item-btn" onclick="removeFromCart('<%= item.product._id %>')">Remove</button>
              </div>
            </div>
          <% }); %>
        </div>

        <div class="cart-summary-card">
          <h2>Order Summary</h2>
          <div class="summary-row">
            <span>Subtotal</span>
            <span>$<%= subtotal.toFixed(2) %></span>
          </div>
          <div class="summary-row">
            <span>Tax (8%)</span>
            <span>$<%= tax.toFixed(2) %></span>
          </div>
          <div class="summary-row">
            <span>Shipping</span>
            <span>$<%= shipping.toFixed(2) %></span>
          </div>
          <div class="summary-divider"></div>
          <div class="summary-row summary-total">
            <span>Total</span>
            <span>$<%= total.toFixed(2) %></span>
          </div>
          <a href="/checkout" class="btn-checkout">Proceed to Checkout</a>
          <a href="/products" class="btn-continue-shopping">Continue Shopping</a>
        </div>
      </div>
    <% } else { %>
      <div class="cart-empty">
        <div class="cart-empty-icon">ðŸ›’</div>
        <h2>Your cart is empty</h2>
        <p>Looks like you haven't added anything to your cart yet.</p>
        <a href="/products" class="btn-primary">Browse Products</a>
      </div>
    <% } %>
  </div>
</section>

<script>
function updateQuantity(productId, quantity) {
  if (quantity < 1) {
    removeFromCart(productId);
    return;
  }
  
  fetch('/cart/update', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ productId, quantity })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      location.reload();
    }
  })
  .catch(err => console.error('Error:', err));
}

function removeFromCart(productId) {
  if (confirm('Are you sure you want to remove this item from your cart?')) {
    fetch('/cart/remove', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ productId })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        location.reload();
      }
    })
    .catch(err => console.error('Error:', err));
  }
}
</script>

<%- include('partials/footer') %>
